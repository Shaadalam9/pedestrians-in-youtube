---
################################
# Super-Linter GitHub Workflow  #
################################
name: Lint codebase

on:
  # Run on every push (including to main, unless you add branches-ignore)
  push:
    # branches-ignore:
    #   - main

  # Run on PRs targeting main
  pull_request:
    branches:
      - main

# Least-privilege permissions:
# - contents:read      -> read repository content
# - statuses:write     -> publish status checks
# - pull-requests:read -> read PR metadata (when event is pull_request)
permissions:
  contents: read
  statuses: write
  pull-requests: read

jobs:
  super-linter:
    name: Lint codebase
    runs-on: ubuntu-latest

    steps:
      # Checkout is required so Super-Linter can access your repository contents.
      # fetch-depth: 0 is important when VALIDATE_ALL_CODEBASE=false so it can
      # correctly compute changed files for pushes/PRs.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Run Super-Linter (container-based).
      #
      # Your failures are from:
      # - CHECKOV
      # - GITHUB_ACTIONS (actionlint)
      # - GITHUB_ACTIONS_ZIZMOR (zizmor)
      #
      # We enable output saving so we can print the detailed findings after the run.
      - name: Run Super-Linter
        uses: super-linter/super-linter@v8.3.2
        env:
          # Required
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Repo settings
          DEFAULT_BRANCH: main

          # Faster runs: lint changed files only
          VALIDATE_ALL_CODEBASE: false

          # Save per-linter outputs to disk so we can inspect them
          # (Super-Linter writes outputs under super-linter-output/... when enabled). :contentReference[oaicite:2]{index=2}
          SAVE_SUPER_LINTER_OUTPUT: true

          # Avoid creating super-linter.log by default:
          # - often ends up root-owned and breaks artifact upload
          # - can contain sensitive environment data if uploaded :contentReference[oaicite:3]{index=3}
          CREATE_LOG_FILE: false

          # Optional: also write a GitHub Actions step summary (nice UX)
          ENABLE_GITHUB_ACTIONS_STEP_SUMMARY: true

          # File filtering:
          FILTER_REGEX_INCLUDE: ".*"
          FILTER_REGEX_EXCLUDE: '(^README\.md$|^templates/|^\.github/ISSUE_TEMPLATE/|^\.github/PULL_REQUEST_TEMPLATE\.md$|^figures/|^mapping_metadata\.csv$)'

          # Linter config location
          LINTER_RULES_PATH: .github/linters
          JSCPD_CONFIG_FILE: .jscpd.json

          # Your existing preferences
          VALIDATE_PYTHON_BLACK: false
          VALIDATE_PYTHON_ISORT: false
          VALIDATE_BIOME_FORMAT: false
          VALIDATE_BIOME_LINT: false

      # Surface the actual failing findings in the job log.
      #
      # Super-Linter saves outputs under:
      #   super-linter-output/super-linter/   (mostly JSON)
      # when SAVE_SUPER_LINTER_OUTPUT=true. :contentReference[oaicite:4]{index=4}
      #
      # This step searches those outputs and prints:
      # - Checkov rule IDs (CKV_*)
      # - actionlint messages for workflows
      # - zizmor security findings
      - name: Print CHECKOV / actionlint / zizmor findings
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          OUT_ROOT="super-linter-output"
          OUT_DIR="${OUT_ROOT}/super-linter"

          echo "Looking for Super-Linter outputs..."
          if [ -d "${OUT_DIR}" ]; then
            echo "Found outputs at: ${OUT_DIR}"
          elif [ -d "${OUT_ROOT}" ]; then
            echo "Found ${OUT_ROOT}, but not ${OUT_DIR}. Listing contents to locate outputs:"
            find "${OUT_ROOT}" -maxdepth 3 -type f -print | sort || true
            # Continue anyway; we might still find something.
          else
            echo "No super-linter-output directory found. Cannot print saved findings."
            exit 0
          fi

          echo ""
          echo "Saved output files (top 200):"
          find "${OUT_ROOT}" -type f -print | sort | head -n 200 || true

          echo ""
          echo "::group::CHECKOV findings (look for CKV_... rule IDs)"
          # Most actionable Checkov info includes CKV_* rule IDs and file/resource references.
          grep -R --line-number -E 'CKV_[A-Z0-9_]+' "${OUT_ROOT}" || true
          echo "::endgroup::"

          echo ""
          echo "::group::GITHUB_ACTIONS (actionlint) findings"
          # actionlint typically references .github/workflows/*.yml and explains the error.
          grep -R --line-number -E 'actionlint|\.github/workflows/|workflow|jobs\.' "${OUT_ROOT}" || true
          echo "::endgroup::"

          echo ""
          echo "::group::GITHUB_ACTIONS_ZIZMOR findings"
          # zizmor findings often mention pinning actions, permissions, pull_request_target, etc.
          grep -R --line-number -i -E 'zizmor|pull_request_target|permissions|pinned|pinning|uses:' "${OUT_ROOT}" || true
          echo "::endgroup::"

      # Upload the saved outputs (not super-linter.log) so you can download them if needed.
      # Uploading only super-linter-output avoids the common root-owned log permission failure
      # and reduces the risk of exposing sensitive environment info. :contentReference[oaicite:5]{index=5}
      - name: Upload Super-Linter outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-output
          path: super-linter-output
          if-no-files-found: warn
