---
################################
# Super-Linter GitHub Workflow  #
################################
name: Lint codebase

on:
  # Run on every push (including to main, unless you add branches-ignore)
  push:
    # branches-ignore:
    #   - main

  # Run on PRs targeting main
  pull_request:
    branches:
      - main

# Keep permissions least-privilege. Super-Linter commonly needs:
# - contents:read      -> checkout + read repository files
# - statuses:write     -> publish commit status checks
# - pull-requests:read -> read PR metadata (PR runs only)
permissions:
  contents: read
  statuses: write
  pull-requests: read

jobs:
  super-linter:
    name: Lint codebase
    runs-on: ubuntu-latest

    steps:
      # Checkout is required so Super-Linter can access repository contents.
      # fetch-depth: 0 is important when VALIDATE_ALL_CODEBASE=false so Super-Linter
      # can compute changed files correctly for pushes/PRs.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Run Super-Linter (container-based).
      #
      # We enable output saving so the detailed findings (especially Checkov/Zizmor)
      # are written to disk under super-linter-output/. This is critical because
      # the console output can sometimes show only a summary.
      - name: Run Super-Linter
        uses: super-linter/super-linter@v8.3.2
        env:
          # Required: used by Super-Linter for GitHub API calls and status checks
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Repository settings
          DEFAULT_BRANCH: main

          # Lint changed files only (faster). Some linters may still scan more broadly.
          VALIDATE_ALL_CODEBASE: false

          # Save per-linter outputs to disk:
          # - super-linter-output/super-linter/* contains stdout/stderr and JSON results
          # - super-linter-output/super-linter-summary.md is a run summary
          SAVE_SUPER_LINTER_OUTPUT: true

          # Do not create super-linter.log by default:
          # - it may be root-owned (permission problems)
          # - it can include sensitive context if uploaded
          CREATE_LOG_FILE: false

          # Optional: writes a GitHub Actions step summary (nice for PR review UX)
          ENABLE_GITHUB_ACTIONS_STEP_SUMMARY: true

          # File filtering:
          # - INCLUDE everything by default
          # - EXCLUDE docs/templates and large/generated artifacts
          FILTER_REGEX_INCLUDE: ".*"
          FILTER_REGEX_EXCLUDE: '(^README\.md$|^templates/|^\.github/ISSUE_TEMPLATE/|^\.github/PULL_REQUEST_TEMPLATE\.md$|^figures/|^mapping_metadata\.csv$)'

          # Tell Super-Linter where repo-stored linter configs live
          LINTER_RULES_PATH: .github/linters

          # JSCPD: ensure it loads .github/linters/.jscpd.json
          JSCPD_CONFIG_FILE: .jscpd.json

          # Keep your existing formatter choices (disabled here)
          VALIDATE_PYTHON_BLACK: false
          VALIDATE_PYTHON_ISORT: false

          # Disable Biome unless you explicitly want it
          VALIDATE_BIOME_FORMAT: false
          VALIDATE_BIOME_LINT: false

      # Print the actual failing outputs into the job log.
      #
      # Why this exists:
      # - Searching/grepping for CKV_* or "zizmor" is unreliable because linters may output
      #   JSON or formats that don't contain those exact strings.
      # - The reliable source of truth is the saved stdout/stderr files and worker JSON
      #   created by Super-Linter when SAVE_SUPER_LINTER_OUTPUT=true.
      #
      # What this step does:
      # - Lists saved output files
      # - Prints the first N lines of Checkov and Zizmor stdout/stderr
      # - Prints the JSON worker results (first N lines)
      # - Best-effort extracts message/error fields using jq (if present)
      - name: Print CHECKOV and ZIZMOR outputs (from saved files)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          OUT_ROOT="super-linter-output/super-linter"

          echo "Super-Linter output root: ${OUT_ROOT}"
          if [ ! -d "${OUT_ROOT}" ]; then
            echo "ERROR: ${OUT_ROOT} not found. Is SAVE_SUPER_LINTER_OUTPUT=true set?"
            exit 0
          fi

          echo ""
          echo "Saved output files (top 200):"
          find "super-linter-output" -type f -print | sort | head -n 200 || true

          # Helper: print file size and first N lines safely
          print_file () {
            local f="$1"
            local n="${2:-200}"

            echo ""
            if [ -f "$f" ]; then
              echo "---- FILE: $f"
              ls -la "$f" || true
              if [ ! -s "$f" ]; then
                echo "(file is empty)"
                return 0
              fi
              echo "---- FIRST ${n} LINES:"
              sed -n "1,${n}p" "$f" || true
            else
              echo "---- FILE: $f (missing)"
            fi
          }

          # Always useful: the generated summary markdown
          print_file "super-linter-output/super-linter-summary.md" 200

          echo ""
          echo "::group::CHECKOV (stdout/stderr/exit code)"
          print_file "${OUT_ROOT}/super-linter-parallel-command-exit-code-CHECKOV" 50
          print_file "${OUT_ROOT}/super-linter-parallel-stdout-CHECKOV" 250
          print_file "${OUT_ROOT}/super-linter-parallel-stderr-CHECKOV" 250
          print_file "${OUT_ROOT}/super-linter-worker-results-CHECKOV.json" 250
          echo "::endgroup::"

          echo ""
          echo "::group::GITHUB_ACTIONS_ZIZMOR (stdout/stderr/exit code)"
          print_file "${OUT_ROOT}/super-linter-parallel-command-exit-code-GITHUB_ACTIONS_ZIZMOR" 50
          print_file "${OUT_ROOT}/super-linter-parallel-stdout-GITHUB_ACTIONS_ZIZMOR" 250
          print_file "${OUT_ROOT}/super-linter-parallel-stderr-GITHUB_ACTIONS_ZIZMOR" 250
          print_file "${OUT_ROOT}/super-linter-worker-results-GITHUB_ACTIONS_ZIZMOR.json" 250
          echo "::endgroup::"

          echo ""
          echo "::group::Best-effort JSON extraction (errors/messages)"
          if command -v jq >/dev/null 2>&1; then
            for j in \
              "${OUT_ROOT}/super-linter-worker-results-CHECKOV.json" \
              "${OUT_ROOT}/super-linter-worker-results-GITHUB_ACTIONS_ZIZMOR.json"
            do
              echo ""
              echo "---- JSON: ${j}"
              if [ -f "${j}" ] && [ -s "${j}" ]; then
                # Print top-level keys and any likely message/error/stderr/stdout fields if present.
                jq -r '
                  [
                    ("keys=" + (keys|join(","))),
                    ("message=" + ((..|objects|.message? // empty) | tostring)),
                    ("error="   + ((..|objects|.error?   // empty) | tostring)),
                    ("stderr="  + ((..|objects|.stderr?  // empty) | tostring)),
                    ("stdout="  + ((..|objects|.stdout?  // empty) | tostring))
                  ]
                  | map(select(length > 0))
                  | .[0:50]
                  | .[]
                ' "${j}" 2>/dev/null || true
              else
                echo "(missing or empty)"
              fi
            done
          else
            echo "jq not installed; skipping JSON extraction."
          fi
          echo "::endgroup::"

      # Upload saved outputs so you can download and inspect them from the workflow run.
      # This is the safest artifact: it contains per-linter outputs and JSON results.
      - name: Upload Super-Linter outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-output
          path: super-linter-output
          if-no-files-found: warn
